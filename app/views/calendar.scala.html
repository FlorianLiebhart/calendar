@(title: String, userName: String)

@scripts = {
  <link rel="stylesheet" media="screen" href="@routes.Assets.at("fullcalendar/fullcalendar.css")">
  <link rel="stylesheet" media="print"  href="@routes.Assets.at("fullcalendar/fullcalendar.print.css")">
  <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/calendar.css")">

  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <script src="@routes.Assets.at("fullcalendar/fullcalendar.min.js")"></script>
  <script src="@routes.Assets.at("javascripts/calendar.js")"></script>

  <script>

    var lastSelected;

    $(document).ready(function() {

      // Causes all popovers to
      $('body').on('click', function (e) {
        $('.popover').each(function () {
          if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0){
              $(this).remove();
            }
        });
      });

      $('#calendar').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,agendaWeek,agendaDay'
        },
        defaultDate: '2014-01-12',
        timezone: 'UTC',
        selectable: true,
        selectHelper: true,
        select: function(start, end, jsEvent, view) { // Reaction to the "select/click" event on the calendar (create new event)
          lastSelected = jsEvent.target;
          createEventPopover(jsEvent.target, start.utc().valueOf(), end.utc().valueOf());
        },
        unselect: function( view, jsEvent ) {
        },
        editable: true,
        events: function(start, end, timezone, callback) { // getting the events from the server
          $.ajax({
            url: '/appointments?from=' + start + '&to=' + end + '&timezone=' + timezone,
            type: 'GET',
            dataType: 'json',
            headers: {
              Accept: "application/json; charset=utf-8",
              "Content-Type": "application/json; charset=utf-8"
            },
            success: function(data) {
              var events = [];
              var appointmentsWithTags = data.appointments
              for (var i = 0; i < appointmentsWithTags.length; i++) {
                var highestPriorityTag = getHighestPriorityTag(appointmentsWithTags[i].tags);

                // console.log(JSON.stringify(highestPriorityTag));
                events.push({
                  'id'     : appointmentsWithTags[i].appointment.id,
                  'title'  : appointmentsWithTags[i].appointment.title + " [tags: " + $.map(appointmentsWithTags[i].tags, function(val) { return val.name; })+"]",
                  'start'  : appointmentsWithTags[i].appointment.start,
                  'end'    : appointmentsWithTags[i].appointment.end,
                  'color'  : highestPriorityTag.color,
                  'tagIds' : $.map(appointmentsWithTags[i].tags, function(v) { return v.id; })
                })

              }
              callback(events);
            },
            error: function() {
              $('#script-warning').show();
            }
          });
        },
        eventRender: function(event, element) {
          element.attr("tagIds", event.tagIds)
        },
        loading: function(bool) {
          $('#loading').toggle(bool);
        },
        eventClick: function(calEvent, jsEvent, view) {
          if (confirm("Delete appointment '" + calEvent.title + "'?")) {
            $.ajax({
              url: '/appointment/' + calEvent.id,
              type: 'DELETE',
              success: function(data) {
                $('#calendar').fullCalendar('removeEvents', function(ev) {
                  return ev.id == calEvent.id;
                });
                findConflicts();
              },
              error: function(xhr) {
                console.log("Can not delete appointment " + JSON.stringify(calEvent));
              },
            })
          }
        },
        eventDrop: function(eventData, revertFunc, jsEvent, ui, view) {
          updateEvent(eventData, revertFunc);
        },
        eventResize: function(eventData, revertFunc, jsEvent, ui, view) {
          updateEvent(eventData, revertFunc);
        }
      });

      findConflicts();
      listTags();
    });

  </script>
}

@navigationBarElements = {

    <li>
        <a href="#">Welcome, @userName!</a>
    </li>
    <li class="divider-vertical"></li>
    <li>
        <a href="/logout">
          <i class="glyphicon glyphicon-log-out"></i> Logout
        </a>
    </li>
    <li class="divider-vertical"></li>
    <li>
        <a href="/admin"> 
          <i class="glyphicon glyphicon-cog"></i> Administration
        </a>
    </li>
    <li class="divider-vertical"></li>
}

@main(title, scripts, navigationBarElements, "") {

  <div id="script-warning">
    <code>Server cannot return any events.</code>
  </div>

  <div id="loading">loading...</div>


  <section id="main">
    <section class="sidebar">
      <div id="tags" class="form-group span4">
        <h3>Tags</h3>
        <ul></ul>
        <button name="add-tag" class="btn btn-xs btn-default" onclick="startAddTag()"><span class="glyphicon glyphicon-plus"></span> Add Tag</button>
        <div class="spacer"></div>
      </div>
      <div class="form-group span4">
        <h3>Proposals</h3>
        <button name="create-proposal" class="btn btn-xs btn-default" onclick="createProposal()">Create Proposal</button>
        <div class="spacer"></div>
      </div>
    </section>

    <section id="calendar"></section>

    <section class="sidebar">
      <div id="conflicts" class="form-group span4">
        <h3>Conflicts</h3>
        <ul class="list-group"></ul>
        <div class="spacer"></div>
      </div>
    </section>
    <section class="log formgroup"></section>
  </section>
}